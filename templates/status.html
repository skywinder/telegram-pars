{% extends "base.html" %}

{% block title %}Статус Парсинга - Telegram Parser{% endblock %}

{% block styles %}
<style>
    .status-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .status-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .status-active { border-left: 5px solid #28a745; }
    .status-inactive { border-left: 5px solid #6c757d; }
    .status-error { border-left: 5px solid #dc3545; }
    .status-interrupted { border-left: 5px solid #ffc107; }

    .progress {
        height: 25px;
        border-radius: 10px;
        margin: 15px 0;
    }

    .progress-bar {
        background: linear-gradient(90deg, #007bff, #28a745);
        transition: width 0.3s ease;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }

    .control-buttons {
        margin: 20px 0;
        text-align: center;
    }

    .timeline-item {
        border-left: 3px solid #007bff;
        padding-left: 20px;
        margin-left: 10px;
        position: relative;
        padding-bottom: 20px;
    }

    .timeline-item:before {
        content: '';
        position: absolute;
        left: -8px;
        top: 0;
        width: 13px;
        height: 13px;
        border-radius: 50%;
        background: #007bff;
    }

    .log-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        font-family: monospace;
        font-size: 14px;
    }

    .log-success { background: #d4edda; color: #155724; }
    .log-warning { background: #fff3cd; color: #856404; }
    .log-error { background: #f8d7da; color: #721c24; }
    .log-info { background: #d1ecf1; color: #0c5460; }
</style>
{% endblock %}

{% block content %}
<div class="status-container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-activity"></i> Статус системы
            </h1>
        </div>
    </div>

    <!-- Основной статус -->
    <div class="row">
        <div class="col-12">
            <div class="status-card" id="main-status">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Состояние парсера</h3>
                    <div id="status-badge">
                        <span class="badge bg-secondary fs-6">
                            <i class="bi bi-circle"></i> Загрузка...
                        </span>
                    </div>
                </div>
                
                <div id="current-task" style="display: none;">
                    <h5 class="text-muted">Текущая задача:</h5>
                    <p class="fs-5" id="task-description">-</p>
                    
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%"
                             id="progress-bar">
                            0%
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between text-muted small">
                        <span>Обработано: <strong id="processed-count">0</strong></span>
                        <span>Всего: <strong id="total-count">0</strong></span>
                        <span>Время: <strong id="elapsed-time">00:00</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="stat-number" id="total-chats">0</div>
                    <div class="text-muted">Чатов обработано</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="stat-number" id="total-messages">0</div>
                    <div class="text-muted">Сообщений загружено</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="stat-number" id="new-messages">0</div>
                    <div class="text-muted">Новых сообщений</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="stat-number" id="api-calls">0</div>
                    <div class="text-muted">API запросов</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4>Управление</h4>
                    <div class="control-buttons">
                        <button class="btn btn-danger" onclick="requestStop()" id="stop-btn" style="display: none;">
                            <i class="bi bi-stop-circle"></i> Остановить парсинг
                        </button>
                        <button class="btn btn-primary" onclick="startParsing()" id="start-btn">
                            <i class="bi bi-play-circle"></i> Запустить парсинг
                        </button>
                        <a href="{{ url_for('parsing_page') }}" class="btn btn-secondary">
                            <i class="bi bi-gear"></i> Настройки парсинга
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-house"></i> На главную
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние события -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4>Последние события</h4>
                    <div id="event-log" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-muted text-center py-3">
                            <i class="bi bi-clock-history"></i> Ожидание событий...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Детали чатов -->
    <div class="row mt-4" id="chat-details" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4>Обработанные чаты</h4>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Чат</th>
                                    <th>Тип</th>
                                    <th>Сообщений</th>
                                    <th>Новых</th>
                                    <th>Время</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody id="chat-list">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let updateInterval = null;
let startTime = null;

// Обновление статуса
async function updateStatus() {
    try {
        const response = await fetch('/api/status/current');
        const data = await response.json();
        
        updateUI(data);
        
        if (data.status === 'parsing' || data.status === 'initializing') {
            if (!updateInterval) {
                updateInterval = setInterval(updateStatus, 1000);
            }
        } else {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }
    } catch (error) {
        console.error('Error updating status:', error);
    }
}

// Обновление интерфейса
function updateUI(data) {
    // Статус бейдж
    const statusBadge = document.getElementById('status-badge');
    const statusHtml = {
        'idle': '<span class="badge bg-secondary fs-6"><i class="bi bi-circle"></i> Неактивен</span>',
        'initializing': '<span class="badge bg-info fs-6"><i class="bi bi-hourglass-split"></i> Инициализация...</span>',
        'parsing': '<span class="badge bg-success fs-6"><i class="bi bi-circle-fill"></i> Парсинг...</span>',
        'interrupted': '<span class="badge bg-warning fs-6"><i class="bi bi-exclamation-circle"></i> Прерван</span>',
        'error': '<span class="badge bg-danger fs-6"><i class="bi bi-x-circle"></i> Ошибка</span>'
    };
    statusBadge.innerHTML = statusHtml[data.status] || statusHtml['idle'];
    
    // Кнопки управления
    const stopBtn = document.getElementById('stop-btn');
    const startBtn = document.getElementById('start-btn');
    
    if (data.status === 'parsing' || data.status === 'initializing') {
        stopBtn.style.display = 'inline-block';
        startBtn.style.display = 'none';
        document.getElementById('current-task').style.display = 'block';
    } else {
        stopBtn.style.display = 'none';
        startBtn.style.display = 'inline-block';
        document.getElementById('current-task').style.display = 'none';
    }
    
    // Текущая задача
    if (data.current_chat) {
        document.getElementById('task-description').textContent = `Обработка: ${data.current_chat}`;
    }
    
    // Прогресс
    if (data.total_chats > 0) {
        const progress = (data.processed_chats / data.total_chats) * 100;
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
        
        document.getElementById('processed-count').textContent = data.processed_chats;
        document.getElementById('total-count').textContent = data.total_chats;
    }
    
    // Статистика
    document.getElementById('total-chats').textContent = data.processed_chats || 0;
    document.getElementById('total-messages').textContent = data.total_messages || 0;
    document.getElementById('new-messages').textContent = data.new_messages || 0;
    document.getElementById('api-calls').textContent = data.api_calls || 0;
    
    // Время
    if (data.status === 'parsing' && !startTime && data.start_time) {
        startTime = new Date(data.start_time);
    }
    
    if (startTime) {
        const elapsed = Math.floor((new Date() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('elapsed-time').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // События
    if (data.recent_events && data.recent_events.length > 0) {
        updateEventLog(data.recent_events);
    }
}

// Обновление лога событий
function updateEventLog(events) {
    const logContainer = document.getElementById('event-log');
    
    if (events.length === 0) {
        return;
    }
    
    let html = '';
    events.forEach(event => {
        const typeClass = {
            'info': 'log-info',
            'success': 'log-success',
            'warning': 'log-warning',
            'error': 'log-error'
        }[event.type] || 'log-info';
        
        html += `
            <div class="log-item ${typeClass}">
                <i class="bi bi-${getIconForType(event.type)}"></i>
                <strong>${event.timestamp}</strong> - ${event.message}
            </div>
        `;
    });
    
    logContainer.innerHTML = html;
}

function getIconForType(type) {
    const icons = {
        'info': 'info-circle',
        'success': 'check-circle',
        'warning': 'exclamation-triangle',
        'error': 'x-circle'
    };
    return icons[type] || 'circle';
}

// Остановка парсинга
async function requestStop() {
    if (confirm('Вы уверены, что хотите остановить парсинг?')) {
        try {
            const response = await fetch('/api/parser/stop', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                alert('Запрос на остановку отправлен');
            }
        } catch (error) {
            console.error('Error stopping parser:', error);
            alert('Ошибка при остановке парсера');
        }
    }
}

// Запуск парсинга
function startParsing() {
    window.location.href = '/parsing';
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    updateStatus();
    
    // Обновляем каждые 5 секунд когда неактивен
    setInterval(function() {
        if (!updateInterval) {
            updateStatus();
        }
    }, 5000);
});
</script>
{% endblock %}