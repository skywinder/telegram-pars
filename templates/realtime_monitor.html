{% extends "base.html" %}

{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π - Telegram Parser{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>
                    <i class="bi bi-broadcast"></i> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                </h1>
                <div id="monitor-status" class="badge fs-6">
                    {% if monitor and monitor.is_running %}
                        <span class="badge bg-success">
                            <i class="bi bi-circle-fill"></i> –ê–∫—Ç–∏–≤–µ–Ω
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-circle"></i> –ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">üì± –ß–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å (CLI)</h6>
                            <ol class="mb-3">
                                <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ <code>python main.py</code></li>
                                <li>–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç <strong>10</strong> –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é</li>
                                <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</li>
                                <li>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–µ, –ª–æ–≥–∏—Ä—É—è –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</li>
                            </ol>
                            
                            <div class="alert alert-light">
                                <strong>–ö–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:</strong>
                                <ul class="mb-0">
                                    <li><code>1</code> - –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö —á–∞—Ç–æ–≤</li>
                                    <li><code>2</code> - –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —á–∞—Ç—ã</li>
                                    <li><code>3</code> - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</li>
                                    <li><code>4</code> - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
                                    <li><code>5</code> - –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary">üåê –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h6>
                            <ol class="mb-3">
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>
                                <li>–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã</li>
                                <li>–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤–Ω–∏–∑—É</li>
                                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
                            </ol>
                            
                            <div class="alert alert-light">
                                <strong>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</strong>
                                <ul class="mb-0">
                                    <li>üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥</li>
                                    <li>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
                                    <li>üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —á–∞—Ç–∞–º –∏ –≤—Ä–µ–º–µ–Ω–∏</li>
                                    <li>üì± –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
                                    <li>üì• –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>–í–∞–∂–Ω–æ:</strong> –î–ª—è —Ä–∞–±–æ—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –º–µ–Ω—é!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    {% if stats %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h3 class="text-primary">{{ stats.total_changes }}</h3>
                    <p class="mb-0">–í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h3 class="text-success">{{ stats.changes_24h }}</h3>
                    <p class="mb-0">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h3 class="text-info">
                        {% if stats.changes_by_type %}
                            {{ stats.changes_by_type | selectattr("type", "equalto", "edited") | map(attribute="count") | first | default(0) }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h3 class="text-danger">
                        {% if stats.changes_by_type %}
                            {{ stats.changes_by_type | selectattr("type", "equalto", "deleted") | map(attribute="count") | first | default(0) }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">–£–¥–∞–ª–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–æ–ø —á–∞—Ç–æ–≤ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º -->
    {% if stats.top_chats %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy"></i> –¢–æ–ø —á–∞—Ç–æ–≤ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for chat in stats.top_chats[:5] %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ chat.name }}</span>
                            <span class="badge bg-primary rounded-pill">{{ chat.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="changesChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
            <select class="form-select" id="periodFilter">
                <option value="1">–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å</option>
                <option value="6">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 6 —á–∞—Å–æ–≤</option>
                <option value="24" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</option>
                <option value="168">–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è</label>
            <select class="form-select" id="typeFilter">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="edited">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                <option value="deleted">–£–¥–∞–ª–µ–Ω–∏–µ</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç—É</label>
            <input type="text" class="form-control" id="chatFilter" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞...">
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        <span id="changesCount" class="badge bg-secondary ms-2">{{ recent_changes|length }}</span>
                    </h5>
                    <button class="btn btn-sm btn-primary" onclick="refreshChanges()">
                        <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="changesList" class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                        {% if recent_changes %}
                            {% for change in recent_changes %}
                            <div class="list-group-item change-item" 
                                 data-type="{{ change.action_type }}"
                                 data-chat="{{ change.chat_name }}"
                                 data-time="{{ change.detected_at }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            {% if change.action_type == 'edited' %}
                                                <span class="badge bg-warning me-2">
                                                    <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–µ–Ω–æ
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger me-2">
                                                    <i class="bi bi-trash"></i> –£–¥–∞–ª–µ–Ω–æ
                                                </span>
                                            {% endif %}
                                            <strong>{{ change.chat_name }}</strong>
                                            <small class="text-muted ms-2">ID: {{ change.message_id }}</small>
                                        </div>
                                        
                                        {% if change.action_type == 'edited' and change.new_content %}
                                            <p class="mb-1">
                                                <small class="text-muted">–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç:</small><br>
                                                {{ change.new_content.text[:200] if change.new_content.text else '–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞' }}
                                                {% if change.new_content.text and change.new_content.text|length > 200 %}...{% endif %}
                                            </p>
                                        {% endif %}
                                        
                                        {% if change.old_content and change.old_content.text %}
                                            <details class="mt-1">
                                                <summary class="text-muted" style="cursor: pointer;">
                                                    <small>–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç</small>
                                                </summary>
                                                <p class="mt-1 mb-0">
                                                    <small>{{ change.old_content.text[:200] }}{% if change.old_content.text|length > 200 %}...{% endif %}</small>
                                                </p>
                                            </details>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">
                                            {{ change.detected_at }}
                                        </small>
                                        <br>
                                        <a href="{{ url_for('chat_messages', chat_id=change.chat_id) }}#msg-{{ change.message_id }}" 
                                           class="btn btn-sm btn-outline-primary mt-1">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-inbox fs-1 text-muted"></i>
                                <p class="text-muted mt-2">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
setInterval(async function() {
    try {
        const response = await fetch('/api/monitor/status');
        const data = await response.json();
        
        const statusEl = document.getElementById('monitor-status');
        if (data.is_active) {
            statusEl.innerHTML = `<span class="badge bg-success"><i class="bi bi-circle-fill"></i> –ê–∫—Ç–∏–≤–µ–Ω</span>`;
        } else {
            statusEl.innerHTML = `<span class="badge bg-secondary"><i class="bi bi-circle"></i> –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>`;
        }
    } catch (error) {
        console.error('Error updating status:', error);
    }
}, 5000);

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
document.getElementById('typeFilter').addEventListener('change', filterChanges);
document.getElementById('chatFilter').addEventListener('input', filterChanges);

function filterChanges() {
    const typeFilter = document.getElementById('typeFilter').value;
    const chatFilter = document.getElementById('chatFilter').value.toLowerCase();
    const items = document.querySelectorAll('.change-item');
    
    let visibleCount = 0;
    items.forEach(item => {
        const type = item.dataset.type;
        const chat = item.dataset.chat.toLowerCase();
        
        const typeMatch = !typeFilter || type === typeFilter;
        const chatMatch = !chatFilter || chat.includes(chatFilter);
        
        if (typeMatch && chatMatch) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    document.getElementById('changesCount').textContent = visibleCount;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function refreshChanges() {
    const hours = document.getElementById('periodFilter').value;
    
    try {
        const response = await fetch(`/api/monitor/recent-changes?hours=${hours}`);
        const data = await response.json();
        
        if (data.changes) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (–∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç—Ä–∏—Å–æ–≤–∫—É)
            location.reload(); // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        }
    } catch (error) {
        console.error('Error refreshing changes:', error);
    }
}

// –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º
{% if stats and stats.changes_by_type %}
const ctx = document.getElementById('changesChart').getContext('2d');
const changesData = {{ stats.changes_by_type | tojson }};

new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: changesData.map(item => item.type === 'edited' ? '–ò–∑–º–µ–Ω–µ–Ω–æ' : '–£–¥–∞–ª–µ–Ω–æ'),
        datasets: [{
            data: changesData.map(item => item.count),
            backgroundColor: [
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
setInterval(function() {
    if (document.getElementById('monitor-status').textContent.includes('–ê–∫—Ç–∏–≤–µ–Ω')) {
        refreshChanges();
    }
}, 10000);
</script>
{% endblock %}