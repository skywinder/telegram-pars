{% extends "base.html" %}

{% block title %}–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä—ã –¥–∏–∞–ª–æ–≥–æ–≤ - Telegram Parser{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-chat-left-text"></i> –ê–Ω–∞–ª–∏–∑ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–≤ –¥–∏–∞–ª–æ–≥–æ–≤
        </h1>
        <p class="lead text-muted">
            –£–∑–Ω–∞–π—Ç–µ, –∫—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –≤ –≤–∞—à–∏—Ö —á–∞—Ç–∞—Ö.
        </p>
    </div>
</div>

{% if starters and not starters.get('error') %}
<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <i class="bi bi-chat-dots fs-1 mb-2"></i>
                <h4>{{ "{:,}".format(starters.total_conversations) }}</h4>
                <small>–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <i class="bi bi-clock fs-1 mb-2"></i>
                <h4>{{ "%.1f"|format(starters.average_gap_hours) }}</h4>
                <small>–ß–∞—Å–æ–≤ –º–µ–∂–¥—É –¥–∏–∞–ª–æ–≥–∞–º–∏</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <i class="bi bi-person-check fs-1 mb-2"></i>
                <h4>{{ starters.conversation_starters|length }}</h4>
                <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–≤</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center bg-warning text-dark">
            <div class="card-body">
                <i class="bi bi-calendar-range fs-1 mb-2"></i>
                <h4>{{ "{:,}".format(starters.analysis_period.total_messages) }}</h4>
                <small>–°–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <canvas id="startersChart" height="250"></canvas>
            </div>
        </div>
        
        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                <th>–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</th>
                                <th>–î–∏–∞–ª–æ–≥–æ–≤ –Ω–∞—á–∞—Ç–æ</th>
                                <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                                <th>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for starter in starters.conversation_starters %}
                            <tr>
                                <td>
                                    {% if loop.index == 1 %}
                                        <span class="badge bg-warning">ü•á {{ loop.index }}</span>
                                    {% elif loop.index == 2 %}
                                        <span class="badge bg-secondary">ü•à {{ loop.index }}</span>
                                    {% elif loop.index == 3 %}
                                        <span class="badge bg-warning">ü•â {{ loop.index }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ loop.index }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                             style="width: 40px; height: 40px;">
                                            {{ starter.sender_name[0].upper() if starter.sender_name else 'U' }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ starter.sender_name[:30] }}</div>
                                            <small class="text-muted">ID: {{ starter.sender_id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ starter.conversations_started }}</span>
                                </td>
                                <td>
                                    <span class="fw-bold {% if starter.percentage > 50 %}text-success{% elif starter.percentage > 30 %}text-warning{% else %}text-muted{% endif %}">
                                        {{ starter.percentage }}%
                                    </span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px; width: 100px;">
                                        <div class="progress-bar {% if starter.percentage > 50 %}bg-success{% elif starter.percentage > 30 %}bg-warning{% else %}bg-info{% endif %}" 
                                             style="width: {{ starter.percentage }}%">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Å–∞–π—Ç–∞–º–∏ -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i> –ò–Ω—Å–∞–π—Ç—ã
                </h5>
            </div>
            <div class="card-body">
                {% set top_starter = starters.conversation_starters[0] %}
                {% set second_starter = starters.conversation_starters[1] if starters.conversation_starters|length > 1 else None %}
                
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="bi bi-trophy"></i> –ì–ª–∞–≤–Ω—ã–π –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
                    </h6>
                    <p class="mb-0">
                        <strong>{{ top_starter.sender_name }}</strong> –Ω–∞—á–∏–Ω–∞–µ—Ç {{ top_starter.percentage }}% –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ 
                        ({{ top_starter.conversations_started }} –∏–∑ {{ starters.total_conversations }})
                    </p>
                </div>
                
                {% if second_starter %}
                <div class="alert alert-secondary">
                    <h6 class="alert-heading">
                        <i class="bi bi-award"></i> –í—Ç–æ—Ä–æ–µ –º–µ—Å—Ç–æ
                    </h6>
                    <p class="mb-0">
                        <strong>{{ second_starter.sender_name }}</strong> –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç {{ second_starter.percentage }}% –¥–∏–∞–ª–æ–≥–æ–≤
                    </p>
                </div>
                {% endif %}
                
                {% if starters.average_gap_hours > 24 %}
                <div class="alert alert-warning">
                    <h6 class="alert-heading">
                        <i class="bi bi-clock-history"></i> –î–ª–∏–Ω–Ω—ã–µ –ø–∞—É–∑—ã
                    </h6>
                    <p class="mb-0">
                        –í —Å—Ä–µ–¥–Ω–µ–º –º–µ–∂–¥—É –¥–∏–∞–ª–æ–≥–∞–º–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç {{ "%.1f"|format(starters.average_gap_hours) }} —á–∞—Å–æ–≤. 
                        –≠—Ç–æ –±–æ–ª–µ–µ —Å—É—Ç–æ–∫!
                    </p>
                </div>
                {% elif starters.average_gap_hours < 2 %}
                <div class="alert alert-success">
                    <h6 class="alert-heading">
                        <i class="bi bi-lightning"></i> –ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ
                    </h6>
                    <p class="mb-0">
                        –ö–æ—Ä–æ—Ç–∫–∏–µ –ø–∞—É–∑—ã –º–µ–∂–¥—É –¥–∏–∞–ª–æ–≥–∞–º–∏ ({{ "%.1f"|format(starters.average_gap_hours) }} —á.) 
                        –≥–æ–≤–æ—Ä—è—Ç –æ–± –∞–∫—Ç–∏–≤–Ω–æ–º –æ–±—â–µ–Ω–∏–∏.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-calendar3"></i> –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞
                </h6>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">–°:</dt>
                    <dd class="col-sm-8">
                        <small>{{ starters.analysis_period.from[:10] if starters.analysis_period.from else 'N/A' }}</small>
                    </dd>
                    
                    <dt class="col-sm-4">–ü–æ:</dt>
                    <dd class="col-sm-8">
                        <small>{{ starters.analysis_period.to[:10] if starters.analysis_period.to else 'N/A' }}</small>
                    </dd>
                    
                    <dt class="col-sm-4">–°–æ–æ–±—â–µ–Ω–∏–π:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-info">{{ "{:,}".format(starters.analysis_period.total_messages) }}</span>
                    </dd>
                </dl>
            </div>
        </div>
        
        <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportStartersData()">
                        <i class="bi bi-file-earmark-text"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="printReport()">
                        <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–≤ -->
{% if starters.conversation_starters|length > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–ø –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <canvas id="comparisonChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞ -->
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            {% if starters and starters.get('error') %}
                <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                <h3 class="mt-4 text-warning">{{ starters.error }}</h3>
                <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ —á–∞—Ç–æ–≤ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</p>
            {% else %}
                <i class="bi bi-chat-left-text display-1 text-muted"></i>
                <h3 class="mt-4 text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞—Ö –¥–∏–∞–ª–æ–≥–æ–≤</h3>
                <p class="text-muted">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥ —á–∞—Ç–æ–≤, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏–∑</p>
            {% endif %}
            
            <div class="mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-primary me-2">
                    <i class="bi bi-house"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
                <a href="{{ url_for('analytics_page') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-graph-up"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if starters and not starters.get('error') %}
<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
const startersData = {{ starters.conversation_starters | tojson }};

// –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
if (startersData && startersData.length > 0) {
    const ctx = document.getElementById('startersChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: startersData.map(s => s.sender_name),
            datasets: [{
                data: startersData.map(s => s.percentage),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#36A2EB'
                ],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const count = startersData[context.dataIndex].conversations_started;
                            return `${label}: ${value}% (${count} –¥–∏–∞–ª–æ–≥–æ–≤)`;
                        }
                    }
                }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–ø-5
    if (startersData.length > 1) {
        const compCtx = document.getElementById('comparisonChart');
        if (compCtx) {
            new Chart(compCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: startersData.slice(0, 5).map(s => s.sender_name.length > 15 ? 
                        s.sender_name.substring(0, 15) + '...' : s.sender_name),
                    datasets: [{
                        label: '–ü—Ä–æ—Ü–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤',
                        data: startersData.slice(0, 5).map(s => s.percentage),
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const starter = startersData[index];
                                    return `${starter.percentage}% (${starter.conversations_started} –¥–∏–∞–ª–æ–≥–æ–≤)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
function exportStartersData() {
    const data = {
        analysis_date: new Date().toISOString(),
        total_conversations: {{ starters.total_conversations }},
        average_gap_hours: {{ starters.average_gap_hours }},
        starters: startersData
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `conversation_starters_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('success', '–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON —Ñ–∞–π–ª');
}

function printReport() {
    window.print();
}

// –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('fade-in');
        }, index * 100);
    });
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach((bar, index) => {
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = bar.style.width; // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
        }, 500 + index * 100);
    });
});
</script>
{% endif %}
{% endblock %}